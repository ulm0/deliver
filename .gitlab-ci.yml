stages:
  - lint
  - test
  - build
  - release

lint:
  image: golang:1.15.0-alpine3.12
  stage: lint
  before_script:
    - apk add --no-cache bash git gcc musl-dev docker vim less file curl wget ca-certificates
    # - git -C /go/src/golang.org/x/lint/golint checkout -b current 06c8688daad7faa9da5a0c2f163a3d14aac986ca
    # - go install golang.org/x/lint/golint
    # - rm -rf /go/src /go/pkg
    # - mkdir -p /go/src/golang.org/x
    # - cd /go/src/golang.org/x
    # - git clone https://github.com/golang/tools
    # - git -C /go/src/golang.org/x/tools checkout -b current aa82965741a9fecd12b026fbb3d3c6ed3231b8f8
    # - go install golang.org/x/tools/cmd/goimports
    # - cd -
    # - rm -rf /go/src /go/pkg
    - wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v1.30.0
    - install ./bin/golangci-lint /bin/golangci-lint
    - rm -f ./bin/golangci-lint
  script:
    - golangci-lint run

.container:
  image: docker:stable
  stage: build
  services:
    - docker:stable-dind
  before_script:
    - apk add --no-cache make
    - echo ${DOCKER_PASSWORD:-$CI_REGISTRY_PASSWORD}|docker login -u=${DOCKER_USER:-$CI_REGISTRY_USER} --password-stdin ${DOCKER_REGISTRY:-$CI_REGISTRY}
  script:
    - make build-docker
    - make push-docker
  after_script:
    - docker logout

# build container image and upload it to gitlab registry
build:docker:
  extends: .container
  except:
    - tags

# build container image and upload it to docker hub
release:docker:
  extends: .container
  stage: release
  variables:
    DOCKER_REGISTRY: docker.io
  only:
    - tags
